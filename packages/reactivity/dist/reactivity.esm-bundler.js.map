{"version":3,"file":"reactivity.esm-bundler.js","sources":["../src/effect.ts","../../shared/src/index.ts","../src/baseHandlers.ts","../src/reactive.ts"],"sourcesContent":["export function effect(fn, options: any = {}) {\n  // 让effect变成响应式的，当数据变化之后重新执行\n  const effect = createReactiveEffect(fn, options);\n  if (!options.lazy) {\n    effect();\n  }\n  return effect;\n}\n\nlet uid = 0;\nlet activeEffect; // 存储当前的effect\nconst effectStack = [];\nfunction createReactiveEffect(fn, options: any = {}) {\n  const effect = function reactiveEffect() {\n    if (!effectStack.includes(effect)) {\n      // 确保effect没有加入到effectStack，否则重复添加会导致页面无限刷新\n      try {\n        effectStack.push(effect);\n        activeEffect = effect;\n        return fn();\n      } finally {\n        effectStack.pop();\n        activeEffect = effectStack[activeEffect.length - 1];\n      }\n    }\n  };\n  effect.id = uid++; // effect标识，用于区分effect\n  effect._isEffect = true; // 标识 这是一个响应式effect\n  effect.raw = fn; // 保留原始的函数\n  effect.options = options; // 保留配置项\n  return effect;\n}\nconst targetMap = new WeakMap();\n// 让某个对象中的属性收集当前他对应的effect函数\nexport function track(target, type, key) {\n  console.log(\"track\", target, type, key);\n  if (activeEffect === undefined) {\n    // 没有在effect中使用，所以这个属性不需要收集\n    return;\n  }\n\n  let depsMap = targetMap.get(target);\n  if (!depsMap) {\n    targetMap.set(target, (depsMap = new Map()));\n  }\n  let dep = depsMap.get(key); // 依赖对应的effect函数\n  if (!dep) {\n    depsMap.set(key, (dep = new Set()));\n  }\n  if (!dep.has(activeEffect)) {\n    dep.add(activeEffect);\n  }\n  console.log(targetMap);\n}\n\nexport function trigger(target, type, key?, newValue?, oldValue?) {\n  console.log(\"trigger :>>>>\", target, type, key, newValue, oldValue);\n}\n","export const isObject = (value) => typeof value == \"object\" && value !== null;\nexport const extend = Object.assign;\nexport const isArray = Array.isArray;\nexport const isFunction = (v) => typeof v === \"function\";\nexport const isNumber = (v) => typeof v === \"number\";\nexport const isString = (v) => typeof v === \"string\";\nexport const isIntegerKey = (key) => parseInt(key) + \"\" === key;\nlet hasOwnProperty = Object.prototype.hasOwnProperty;\nexport const hasOwn = (target, key) => hasOwnProperty.call(target, key);\nexport const hasChanged = (oldValue, value) => oldValue === value;\n","// 实现代理处理\n// 是不是只读，只读的set需要报异常\n// 是不是深度得\n/**\n * 后续object上面的方法会被迁移到reflect Reflect.getProptypeof()\n * Reflect方法有返回值，可以知道操作是否成功,失败需要报异常\n * Reflect可以不使用proxy es6的语法\n */\nimport {\n  extend,\n  hasChanged,\n  hasOwn,\n  isArray,\n  isIntegerKey,\n  isObject,\n} from \"@vue/shared\";\nimport { track, trigger } from \"./effect\";\nimport { reactive, readonly } from \"./reactive\";\n// 拦截取值功能\nfunction createGetter(isReadonly = false, shallow = false) {\n  return function get(target, key, receiver) {\n    const res = Reflect.get(target, key, receiver);\n    if (!isReadonly) {\n      // 收集依赖，等会数据变化后更新对应的视图\n      console.log(\"执行effect时会取值,收集effect\");\n      track(target, TrackOperatorTypes.GET, key);\n    }\n\n    if (shallow) {\n      return res;\n    }\n\n    if (isObject(res)) {\n      // vue 2是一上来就递归，vue3是当取值是才会进行代理，是懒代理\n      return isReadonly ? readonly(res) : reactive(res);\n    }\n\n    return res;\n  };\n}\n// 拦截赋值功能\nfunction createSetter(shallow = false) {\n  return function get(target, key, value, receiver) {\n    const res = Reflect.set(target, key, value, receiver);\n    // 当数据更新时 通知对应的属性的effect重新执行\n    // 需要区分是新增还是修改，vue2里面无法监控索引的更改，无法监控数组的长度变化=》hack方法，特殊处理\n    const oldValue = target[key];\n    let hasKey =\n      isArray(target) && isIntegerKey(key)\n        ? Number(key) < target.length\n        : hasOwn(target, key);\n    if (!hasKey) {\n      // 判断是新增还是修改\n      // 不存在这个key，所以是新增\n      trigger(target, TriggerOperatorTypes.ADD, key, value);\n    } else if (hasChanged(oldValue, value)) {\n      // 修改\n      trigger(target, TriggerOperatorTypes.SET, key, value, oldValue);\n    }\n    return res;\n  };\n}\nconst get = createGetter();\nconst shallowGet = createGetter(false, true);\nconst readonlyGet = createGetter(true);\nconst shallowReadonlyGet = createGetter(true, true);\nconst readonlyObj = {\n  set: (target, key) => {\n    console.warn(`set on key ${key} failed`);\n  },\n};\nconst set = createSetter();\nconst shallowSet = createSetter(true);\n\nexport const mutableHandlers = { get, set };\nexport const shallowReactiveHandlers = { get: shallowGet, set: shallowSet };\nexport const readonlyHandlers = extend(\n  {\n    get: readonlyGet,\n  },\n  readonlyObj\n);\nexport const shallowReadonlyHandlers = extend(\n  { get: shallowReadonlyGet },\n  readonlyObj\n);\n","import { isObject } from \"@vue/shared\";\nimport {\n  mutableHandlers,\n  readonlyHandlers,\n  shallowReactiveHandlers,\n  shallowReadonlyHandlers,\n} from \"./baseHandlers\";\n\nexport function reactive(target) {\n  return createReactiveObject(target, false, mutableHandlers);\n}\n\nexport function shallowReactive(target) {\n  return createReactiveObject(target, false, shallowReactiveHandlers);\n}\n\nexport function readonly(target) {\n  return createReactiveObject(target, true, readonlyHandlers);\n}\n\nexport function shallowReadonly(target) {\n  return createReactiveObject(target, true, shallowReadonlyHandlers);\n}\n\n/**\n * 是不是只读\n * 是不是深度\n * 柯里化\n * new proxy() 最核心的需求是拦截，数据的读取和修改 Get Set\n *\n */\nconst reactiveMap = new WeakMap();\nconst readonlyMap = new WeakMap();\nexport function createReactiveObject(target, isReadonly, baseHandlers) {\n  // 如果目标不是对象，则没办法拦截，reactive只能拦截对象类型\n  if (!isObject(target)) {\n    return target;\n  }\n  // 如果某个对象已经被代理过了，就不需要再次代理，可能对象的代理是深度得，又被只读代理了\n  const proxyMap = isReadonly ? readonlyMap : reactiveMap;\n  const existProxy = proxyMap.get(target);\n  if (existProxy) {\n    return existProxy; // 直接返回已经被代理过得对象\n  }\n  const proxy = new Proxy(target, baseHandlers);\n  proxyMap.set(target, proxy);\n  return proxy;\n}\n"],"names":[],"mappings":"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"}